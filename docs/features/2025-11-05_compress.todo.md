# TODO — Compress Selected node_modules (ZIP)

This is the actionable task list to implement the compression feature described in `2025-11-05_compress.md`.

## 0) Groundwork
- [x] Create `internal/compressor` package scaffold
  - [x] Types: `Target{Path, Size}`, `Progress{Completed, Total, Path, Dest, BytesWritten, Err}`, `Summary{Successes[{Path, Dest, Size}], Failures, Written}`
  - [x] Options: `OutDir`, `Concurrency`, `DeleteAfter`
  - [x] Public: `CompressTargets(ctx, targets, opts, progressCh) Summary`

## 1) ZIP Compressor
- [x] Implement directory → zip writer using stdlib `archive/zip`
- [x] Preserve file modes and timestamps where possible
- [x] Skip symlinks for portability
- [x] Destination path logic (sibling default): `<basename>.zip` with `-N` suffix on collision
- [x] Top‑level folder inside archive equals `<basename>/` for clean extraction
- [x] Emit progress (bytes written, last path, completed/total)
- [x] `DeleteAfter`: remove source dir only on success (default enabled)

## 2) CLI Integration
- [x] Flags: `--compress-json`, `--compress-stdin`, `--out-dir`, `--delete-after`, `--yes`, `--json`
- [x] Support reading targets from file/stdin (reuse delete JSON parsing)
- [x] Non-interactive run path invoking compressor and printing summary (text/JSON)
- [x] Exit codes consistent with delete (non‑zero if failures > 0)

## 3) TUI Integration
- [x] Dual selection state per item: `selDel`, `selZip`
- [x] Keybindings: `space`/`x` toggle [x]; `z` toggle [z]; `A`/`X`/`ctrl+a` mark all [x]; `Z` mark all [z]; `R` invert (z→·, x→·, ·→x)
- [x] Mutually exclusive selection (last action wins)
- [x] Enter/d acts on [x] first else [z]
- [x] Header counters: `Selected(del)` and `Selected(zip)` sizes
- [x] Help panel reflects new keys and invert logic
- [x] Confirm screen for compress: count + total size + note that delete‑after is default
- [x] Progress view: spinner, `n/N`, last path, bytes written, destination path; cancel with `q`
- [x] Completion screen: list failures; show total written and per‑item destinations

## 4) Scanner/Selection Interop
- [x] Ensure selections respect filtering view
- [x] Clear compress selection on item delete success
- [x] Maintain selection cursor behavior/scroll after compress/remove

## 5) Tests
- [ ] Unit: compressor (tiny trees), zip contents round‑trip (names, file count, sizes)
- [ ] Symlink behavior (not followed by default)
- [ ] Collision naming (`-N` increment)
- [x] DeleteAfter safety (only after successful archive)
- [ ] CLI: JSON input/output happy path and failure path
- [ ] TUI: model logic tests for dual selection, counters, transitions

## 6) Docs & Examples
- [x] README: add `space`/`x`, `A`/`X`, `z`, `Z`, `R` keys; compress section; examples
- [x] CLI usage examples for `--compress-json`, `--out-dir`, `--delete-after`; sample targets.json
- [x] Update `docs/features/2025-11-05_compress.md` to reflect final behavior

## 7) Packaging & Release
- [ ] Ensure archives are not included in release artifacts (only the binary)
- [ ] Add brief release notes entry

## Acceptance Criteria
- [ ] Compress N directories into separate `.zip` files with correct names
- [ ] No data loss: original directories remain unless `--delete-after` is set and the archive succeeded
- [ ] TUI keys work as documented; counters accurate; cancel works
- [ ] CLI returns non‑zero on failures; JSON summary matches schema

## Risks / Follow‑ups
- [ ] Disk space low: add warning if destination filesystem appears constrained
- [ ] Windows path edge cases: long paths; test on CI
- [ ] Optional: checksum per archive in JSON summary (future)
