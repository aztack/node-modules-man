# Feature Plan — Compress Selected node_modules (Nov 5, 2025)

Goal: Add a non‑destructive “compress” option in addition to delete. Users can mark items for compression from the TUI and run a compression job with progress and cancellation.

## UX Overview
- Keybindings
  - `space` / `x` → toggle delete `[x]`
  - `z` → toggle compress `[z]`
  - `A` / `X` / `ctrl+a` → mark all `[x]` (filtered view)
  - `Z` → mark all `[z]` (filtered view)
  - `R` → invert marks (z→·, x→·, ·→x)
  - `d` / `enter` → act: delete if any `[x]`, else compress if any `[z]`
  - `?` shows updated help
- Indicators in list
  - `[x]` for items selected to delete
  - `[z]` for items selected to compress
  - If both are toggled on the same row, last action wins; we show only one marker to avoid ambiguity (see Rules below)
- Header
  - Show two counters: `Selected(del): <size>` and `Selected(zip): <size>`
  - Keep filter/sort hints as today

## Rules
- A single item can be in at most one action set at a time.
  - Tapping `space`/`x` clears `[z]` and sets `[x]`
  - Tapping `z` clears `[x]` and sets `[z]`
- Sort/filter behavior unaffected; selection sets respect the filtered view
- Delete and compress are distinct confirms/screens; `enter` chooses based on which set is non‑empty
- Cancellation with `q` behaves like delete flow: cancels running compression workers

## Compression Behavior
- Format
  - Use `zip` on all platforms for maximum compatibility and solid ratio/speed
- Output location
  - Default: sibling to the source directory (e.g., `.../node_modules` → `.../node_modules.zip`)
  - CLI/TUI option to override: `--out-dir` (absolute/relative to scan root)
- Archive naming & structure
  - Zip file name: `<basename>.zip`; if exists, append `-N`
  - Archive contents have a top‑level `<basename>/` directory so extraction creates `node_modules/`
- Integrity
  - Preserve file modes and timestamps where supported by format
  - Symlinks are skipped for portability

## CLI Flags (new)
- `--compress-json` / `--compress-stdin`  Compress targets from JSON (paths or objects like delete)
- `--out-dir`            Where to place archives
- `--delete-after`       Remove original directory after successful compression (default: true)
- `--yes`                Skip prompt (same semantics as delete)
- `--json`               Emit machine‑readable summary

## TUI Flow
1) Mark items with `z` (shows `[z]`)
2) Press `enter` (or `Z` to mark all first) to open confirm: “Compress N node_modules to zip?” with estimated total size
3) Show progress view: spinner, `n/N` completed, last path, bytes written, destination path
4) On completion, show summary with per‑item result and destination file sizes
5) Originals are deleted after successful compression by default (no extra prompt)

## Data Structures & Packages
- New package: `internal/compressor`
  - API: `CompressTargets(ctx, targets, opts, progressCh) Summary`
  - Options: `OutDir`, `Concurrency`, `DeleteAfter` (zip only)
  - Progress: `{Completed, Total, Path, Dest, BytesWritten, Err}`
  - Summary: `{Successes: [{Path, Dest, Size}], Failures: [...], Written}`
- TUI model
  - Track two selections per item: `selDel` and `selZip`
  - Keep two aggregates: `selDelSize`, `selZipSize`
  - Render `[x]` when `selDel`, `[z]` when `selZip`
  - Mutually exclusive toggles (`space`/`x` vs `z`)
  - Confirm and run compression similar to delete, with cancel support and per‑file byte progress

## Implementation Steps
1) `internal/compressor` with zip writer (use stdlib `archive/zip`)
2) Wire CLI flags and command path for non‑interactive compression
3) Extend TUI model: dual selections, key handling, counters, help text
4) Add confirm and progress views for compression
5) Header/help updates for keys and counters
6) Tests: compressor unit tests (round‑trip structure, pathing, symlinks), TUI model transitions
7) Update README with keys, CLI flags, and examples

## Alternatives & Open Questions
- Trigger key for compress
  - Option A (current): `Z` starts compression; `z` toggles selection
  - Option B: reuse `enter` for context (delete if `[x]` present else compress if `[z]` present); rejected for clarity
- Output location
  - Keep default sibling to source; or a central archive directory under scan root (configurable)
- Post‑compress cleanup
  - `--delete-after` is powerful but dangerous; gate behind an explicit confirmation

## Metrics & Telemetry (optional)
- Count compressed bytes and time to report throughput
- Track failure reasons to improve messaging (permissions, space, long paths)

## Risks & Mitigations
- Disk‑space exhaustion: show destination free space if cheaply available; warn on low space
- Windows path/permission quirks: normalize paths, avoid long‑path issues
- Performance on very large trees: chunked walking + streaming writers, limit concurrency of active compressors

## Suggested Extras
- “Open archive folder” action after completion (platform‑aware command)
- Per‑item context hint on right side: `[A] all‑delete, [Shift+Z] all‑compress` for view
- Config for default format and output directory
- Optional checksum file per archive (SHA256) when `--json` enabled
