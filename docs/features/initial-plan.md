# node-module-man 实施计划（Implementation Plan）

本文档给出从零到可用的实现计划，覆盖架构设计、分阶段里程碑、关键任务清单、测试与发布策略。目标是在保证可维护性的前提下，快速交付一个稳定、跨平台的 `node_modules` 清理 TUI 工具。

## 1. 目标与范围（Scope）

- 目标：扫描指定根目录下所有 `node_modules`，统计空间占用，提供交互式 TUI 多选删除与进度反馈。
- 支持平台：macOS / Linux / Windows（不依赖平台特有命令）。
- 性能：并发扫描与删除，保证 TUI 不阻塞；可在百万级文件下保持可用。
- 安全：删除前二次确认；默认跳过无法访问或权限不足目录，给出错误汇总；提供 `--dry-run`。

## 2. 架构概览（Architecture）

- 分层设计：
  - `scanner`（业务核心）：递归检索 `node_modules` 目录；并发计算目录大小；进度/结果通过 channel 流式上报。
  - `deleter`（业务核心）：并发安全删除已选目录；上报进度/错误。
  - `tui`（表示层）：Bubble Tea `Model-View-Update`；状态机驱动；列表/筛选/排序/多选/确认/进度。
  - `cli`（适配层）：解析参数、环境与日志；可运行无 TUI 的纯 CLI（便于调试与自动化）。
  - `pkg/utils`：格式化（size、路径）、限流、错误聚合、平台兼容处理。

## 3. 里程碑（Milestones）

1) M1 — 项目初始化与核心扫描库（1-2 天）
2) M2 — 基本 CLI：打印结果与总占用（0.5 天）
3) M3 — TUI 骨架与加载/结果列表（1-2 天）
4) M4 — 多选、排序、筛选、统计（1 天）
5) M5 — 删除确认、并发删除、进度与结果汇总（1-2 天）
6) M6 — 稳定性与跨平台修正、测试补齐、打包与文档（1-2 天）

## 4. 详细任务（By Phase）

### 4.1 M1：项目初始化与扫描库

- Go 模块初始化：`go mod init github.com/<org>/node-module-man`
- 依赖：
  - `github.com/charmbracelet/bubbletea`（TUI）
  - `github.com/charmbracelet/bubbles`（spinner、list、progress）
  - `github.com/charmbracelet/lipgloss`（样式）
- 目录结构：
  - `cmd/node-module-man/`：主入口（TUI/CLI 选择）
  - `internal/scanner/`：扫描与大小统计
  - `internal/deleter/`：删除器
  - `internal/tui/`：TUI 模型与视图
  - `internal/cli/`：非 TUI 模式与参数解析
  - `pkg/utils/`：通用工具
- 扫描器设计：
  - 输入：根路径、并发度、最大深度、排除模式、是否跟随符号链接（默认否）。
  - 递归发现 `node_modules`：优先使用 `filepath.WalkDir`，配合 goroutine 池；遇到 `node_modules` 可跳过其子树继续（避免重复）。
  - 目录大小：
    - 并发为每个 `node_modules` 计算大小；忽略符号链接与无权限文件；累计字节数。
    - 可选：限制最大并发（`semaphore`）与 IO 限流，避免磁盘打满。
  - 输出：通过 channel 流式返回 `ResultItem{Path, Size, Err}`；同时返回总进度（已发现/已完成大小计算数量）。
  - 取消：支持 `context.Context` 取消扫描。
  - 错误处理：收集但不阻断，最终返回错误列表。
  - 单元测试：
    - 临时目录构造多层结构，含多个 `node_modules`、符号链接、无权限文件等。
    - 校验发现数量、大小计算与错误聚合。

### 4.2 M2：基本 CLI（无 TUI）

- 参数：`--path`（默认 cwd）、`--max-depth`、`--concurrency`、`--exclude`、`--json`、`--dry-run`。
- 行为：运行扫描，按表格或 JSON 打印每个 `node_modules` 与总占用；为后续 TUI 验证提供基线。

### 4.3 M3：TUI 骨架

- `model` 状态：`Status`（Scanning/Ready/Deleting/Done）、`Path`、`Results`、`Cursor`、`Spinner`、`TotalSize`、`Filter`、`SortBy`、`Selected` 等。
- Init：启动后台扫描（使用 `tea.Cmd` 包装），显示 `spinner` 与实时统计（已发现目录数、累计大小）。
- Update：
  - 处理扫描进度消息：增量插入结果列表；更新合计。
  - 处理键盘：上下移动、帮助（`?`/`h`）、退出（`q`/`esc`）。
- View：
  - 扫描中：顶部状态栏 + `spinner` + 已发现计数与大小。
  - 扫描完成：切至结果列表视图。

### 4.4 M4：列表交互、排序、筛选

- 列表：`bubbles/list` 或自定义列表，支持多选（空格切换选中）。
- 排序：按大小/路径升降序；键位如 `s` 切换字段、`r` 反转。
- 筛选：输入过滤（路径子串匹配）；清除过滤快捷键。
- 统计：展示选中数量、选中总大小与全部总大小。
- 体验：使用 `lipgloss` 美化布局与颜色（兼容暗/亮主题）。

### 4.5 M5：删除流程

- 触发：`d` 或 `enter` 开启删除确认对话框（Modal）。
- 确认：显示选中目录数量与将释放的空间；支持输入 `y/YES` 或再次回车确认；`esc` 取消。
- 删除执行：
  - 并发删除（受限并发），逐个 `os.RemoveAll`，支持上下文取消。
  - 进度：进度条/百分比与已完成计数；错误项记录并展示。
  - `--dry-run`：仅展示将删除的路径与潜在释放空间，不做实际删除。
- 结果：删除完成后显示总结：成功/失败数量、释放空间、失败原因列表；可返回列表或退出。

### 4.6 M6：稳定性、跨平台与打包

- 跨平台细节：
  - Windows 路径与权限：处理长路径（`\\?\` 前缀）、UAC 权限不足提示。
  - 符号链接：默认不跟随；若跟随需循环检测并限制深度。
  - 权限错误与占用中文件：失败时给出可读提示，继续处理其他项。
- 性能优化：
  - 扫描与删除的最大并发、队列长度可配置；粗略自适应 CPU/IO。
  - 尽量减少在 TUI 主线程中的重计算（如排序/过滤在后台完成，或做增量更新）。
- 观感优化：
  - 大目录扫描时的“仍在统计中”占位；结果到齐后刷新大小。
  - 统一的 size 格式化（B/KB/MB/GB 自动选择）。
- 打包：
  - `make release`：交叉编译 `darwin/amd64, darwin/arm64, linux/amd64, windows/amd64`。
  - 生成校验和与简要发布说明。

## 5. 键位与交互（Draft）

- 基本：`↑/k` 上、`↓/j` 下、`q` 退出、`?` 帮助。
- 多选：`space` 选择/取消选择。
- 排序：`s` 切换字段（size/path）、`r` 升降序切换。
- 筛选：`/` 进入输入模式、`esc` 退出并清空。
- 删除：`d`/`enter` 打开确认对话框；`y/enter` 确认、`esc` 取消。

## 6. 配置与参数（CLI）

- `--path` 根路径（默认当前目录）
- `--max-depth` 最大深度（默认无限）
- `--concurrency` 并发度（默认 4-8，随平台自适应）
- `--exclude` 排除模式（可多次，glob）
- `--json` 非 TUI 输出 JSON
- `--dry-run` 删除阶段不实际删除
- `--tui=false` 仅以 CLI 运行（便于脚本化）

## 7. 测试计划（Testing）

- 单元测试：
  - `scanner`：多层目录、空目录、权限错误、符号链接、巨量小文件。
  - `deleter`：临时目录下的并发删除正确性与错误聚合。
  - `utils`：size 格式化、排序/筛选函数。
- 集成测试：
  - 构建临时工程树，完整跑扫描→选择→删除→校验空间与路径存在性。
- 手动验证：
  - 不同平台下的路径显示、键位、进度渲染；大体量目录的交互流畅度。

## 8. 质量与安全（QoS & Safety）

- 删除前强制确认（含数量与总大小）。
- 默认跳过系统/隐藏关键目录（如仓库根的 `node_modules` 之外的非目标路径）。
- 明确告知不可逆操作，无“回收站”保证；可考虑后续支持移动到系统垃圾桶（需额外依赖，暂不做）。
- 避免误删：仅允许删除目录名精确为 `node_modules` 的路径。

## 9. 交付物（Deliverables）

- 可执行二进制：`node-module-man`（三平台）。
- 源码：按上述目录结构组织，关键模块有测试覆盖。
- 文档：`README.md`（安装、使用、截图/GIF、FAQ）、`docs/prd.md`、`docs/plan.md`。

## 10. 验收标准（Acceptance Criteria）

- 在包含 10+ 个 `node_modules`、总体积 > 10GB 的目录树上，能在可接受时间内（视磁盘 IO）完成扫描并给出大小统计。
- TUI 可流畅浏览、筛选、排序与多选；删除流程有确认、进度与结果总结；支持取消。
- 错误不致崩溃，均有可理解提示；返回码符合约定（成功 0，部分失败非 0）。
- 代码通过基础单元测试；关键路径具备可读性与可维护性。

---

如需，我可以基于本计划直接初始化仓库结构与最小可运行版本（M1+M2），再逐步集成 TUI 与删除能力。

